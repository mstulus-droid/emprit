<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>üê¶ Flappy Sky Adventure</title>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Nunito:wght@400;700;900&display=swap');
        
        * {
            margin: 0; padding: 0; box-sizing: border-box;
            user-select: none; -webkit-user-select: none; touch-action: none;
        }

        body {
            display: flex; justify-content: center; align-items: center;
            min-height: 100vh; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            overflow: hidden; font-family: 'Nunito', sans-serif;
        }

        #game-wrapper {
            position: relative; width: 100%; max-width: 450px;
            height: 100vh; max-height: 800px; background: #fff;
            border-radius: 20px; overflow: hidden;
            box-shadow: 0 25px 50px -12px rgba(0, 0, 0, 0.25), 0 0 0 1px rgba(255, 255, 255, 0.1);
        }

        @media (min-width: 450px) { #game-wrapper { height: 800px; margin: 20px; } }

        canvas { display: block; width: 100%; height: 100%; }

        .ui-layer {
            position: absolute; top: 0; left: 0; width: 100%; height: 100%;
            pointer-events: none; display: flex; flex-direction: column; align-items: center;
        }

        .hud { width: 100%; padding: 20px; display: flex; justify-content: space-between; align-items: flex-start; z-index: 10; }

        .score-box {
            background: rgba(255, 255, 255, 0.95); padding: 10px 20px; border-radius: 20px;
            box-shadow: 0 4px 15px rgba(0,0,0,0.1); text-align: center; min-width: 80px;
        }
        .score-label { font-size: 11px; color: #888; font-weight: 700; text-transform: uppercase; letter-spacing: 1px; }
        .score-value { font-size: 32px; font-weight: 900; color: #ff6b6b; line-height: 1; margin-top: 2px; }

        .medal {
            width: 50px; height: 50px; background: linear-gradient(135deg, #ffd93d 0%, #ff6b6b 100%);
            border-radius: 50%; display: flex; align-items: center; justify-content: center;
            font-size: 24px; box-shadow: 0 4px 15px rgba(255, 107, 107, 0.4);
            animation: float 3s ease-in-out infinite;
        }
        @keyframes float { 0%, 100% { transform: translateY(0); } 50% { transform: translateY(-5px); } }

        .combo-banner {
            position: absolute; top: 100px; background: linear-gradient(90deg, #ff6b6b, #ffd93d);
            color: white; padding: 8px 25px; border-radius: 25px; font-weight: 900; font-size: 18px;
            opacity: 0; transform: scale(0) rotate(-10deg); transition: all 0.3s cubic-bezier(0.68, -0.55, 0.265, 1.55);
            box-shadow: 0 5px 20px rgba(255, 107, 107, 0.4); z-index: 20;
        }
        .combo-show { opacity: 1; transform: scale(1) rotate(0deg); }

        .powerup-indicator { position: absolute; left: 20px; bottom: 100px; display: flex; flex-direction: column; gap: 10px; }
        .powerup-badge { 
            width: 45px; height: 45px; border-radius: 12px; display: flex; align-items: center; justify-content: center; 
            font-size: 22px; background: rgba(255,255,255,0.9); box-shadow: 0 4px 15px rgba(0,0,0,0.1); 
            opacity: 0.3; transform: scale(0.8); transition: all 0.3s; position: relative; overflow: hidden;
        }
        .powerup-badge.active { opacity: 1; transform: scale(1); animation: glow 2s infinite; }
        .powerup-timer-bar {
            position: absolute; bottom: 0; left: 0; height: 4px; background: currentColor;
            transition: width 0.1s linear; width: 100%;
        }
        @keyframes glow { 0%, 100% { box-shadow: 0 0 5px currentColor; } 50% { box-shadow: 0 0 20px currentColor, 0 0 40px currentColor; } }
        .shield { color: #4299e1; } .magnet { color: #ecc94b; } .slowmo { color: #9f7aea; }

        .screen {
            position: absolute; top: 0; left: 0; width: 100%; height: 100%;
            display: flex; flex-direction: column; justify-content: center; align-items: center;
            background: rgba(255, 255, 255, 0.98); backdrop-filter: blur(20px);
            transition: all 0.5s cubic-bezier(0.4, 0, 0.2, 1); pointer-events: auto; z-index: 100; padding: 40px;
        }
        .hidden { opacity: 0; pointer-events: none !important; transform: scale(1.1); }

        .logo { font-size: 48px; margin-bottom: 10px; animation: bounce 2s infinite; }
        @keyframes bounce { 0%, 100% { transform: translateY(0); } 50% { transform: translateY(-10px); } }

        h1 { font-size: 36px; font-weight: 900; color: #2d3748; margin-bottom: 10px; text-align: center; line-height: 1.2; }
        .subtitle { color: #718096; font-size: 16px; margin-bottom: 30px; text-align: center; line-height: 1.5; }

        .stats-container { display: grid; grid-template-columns: repeat(3, 1fr); gap: 15px; width: 100%; margin-bottom: 30px; }
        .stat-card { background: #f7fafc; border-radius: 15px; padding: 15px; text-align: center; border: 2px solid transparent; transition: all 0.3s; }
        .stat-icon { font-size: 24px; margin-bottom: 5px; }
        .stat-value { font-size: 20px; font-weight: 900; color: #2d3748; }
        .stat-label { font-size: 11px; color: #a0aec0; margin-top: 2px; }

        .btn-primary {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; border: none;
            padding: 18px 50px; font-size: 20px; font-weight: 900; border-radius: 30px; cursor: pointer;
            box-shadow: 0 10px 30px rgba(102, 126, 234, 0.4); transition: all 0.3s; font-family: inherit; position: relative; overflow: hidden;
        }
        .btn-primary:hover { transform: translateY(-2px); box-shadow: 0 15px 40px rgba(102, 126, 234, 0.5); }
        .btn-primary:active { transform: translateY(0); }

        .btn-secondary { background: white; color: #667eea; border: 3px solid #667eea; padding: 15px 40px; font-size: 18px; font-weight: 700; border-radius: 30px; cursor: pointer; transition: all 0.3s; font-family: inherit; margin-top: 15px; }
        .btn-secondary:hover { background: #667eea; color: white; }

        .game-over-content { text-align: center; width: 100%; }
        .crash-icon { font-size: 80px; margin-bottom: 20px; animation: shake 0.5s; }
        @keyframes shake { 0%, 100% { transform: rotate(0); } 25% { transform: rotate(-10deg); } 75% { transform: rotate(10deg); } }

        .final-score-box { background: linear-gradient(135deg, #ff6b6b 0%, #ffd93d 100%); color: white; padding: 30px; border-radius: 20px; margin-bottom: 25px; box-shadow: 0 10px 30px rgba(255, 107, 107, 0.3); }
        .final-score-label { font-size: 14px; opacity: 0.9; margin-bottom: 5px; }
        .final-score-value { font-size: 56px; font-weight: 900; line-height: 1; }

        .details-grid { display: grid; grid-template-columns: repeat(2, 1fr); gap: 15px; margin-bottom: 25px; width: 100%; }
        .detail-item { background: #f7fafc; padding: 15px; border-radius: 12px; }
        .detail-label { font-size: 12px; color: #a0aec0; margin-bottom: 4px; }
        .detail-value { font-size: 24px; font-weight: 900; color: #2d3748; }

        .new-record { background: linear-gradient(90deg, #ffd93d, #ff6b6b); color: white; padding: 10px 20px; border-radius: 20px; font-weight: 900; font-size: 14px; margin-bottom: 20px; animation: pulse 1s infinite; display: none; }
        .new-record.show { display: inline-block; }
        @keyframes pulse { 0%, 100% { transform: scale(1); } 50% { transform: scale(1.05); } }

        .floating-text { position: absolute; font-weight: 900; font-size: 24px; pointer-events: none; animation: floatUp 1s ease-out forwards; z-index: 50; text-shadow: 0 2px 10px rgba(0,0,0,0.2); }
        @keyframes floatUp { 0% { opacity: 1; transform: translateY(0) scale(1); } 100% { opacity: 0; transform: translateY(-80px) scale(1.3); } }

        .shield-timer-ring {
            position: absolute;
            pointer-events: none;
            z-index: 5;
        }
    </style>
</head>
<body>
    <div id="game-wrapper">
        <canvas id="game"></canvas>
        
        <div class="ui-layer">
            <div class="hud">
                <div class="score-box">
                    <div class="score-label">Score</div>
                    <div class="score-value" id="score-display">0</div>
                </div>
                <div class="medal" id="medal">ü•â</div>
            </div>

            <div class="combo-banner" id="combo-banner">COMBO x2!</div>

            <div class="powerup-indicator">
                <div class="powerup-badge shield" id="badge-shield">
                    üõ°Ô∏è
                    <div class="powerup-timer-bar" id="timer-shield"></div>
                </div>
                <div class="powerup-badge magnet" id="badge-magnet">
                    üß≤
                    <div class="powerup-timer-bar" id="timer-magnet"></div>
                </div>
                <div class="powerup-badge slowmo" id="badge-slowmo">
                    ‚è±Ô∏è
                    <div class="powerup-timer-bar" id="timer-slowmo"></div>
                </div>
            </div>
        </div>

        <div id="start-screen" class="screen">
            <div class="logo">üê¶</div>
            <h1>Sky Adventure</h1>
            <p class="subtitle">Terbang melewati pipa,<br>kumpulkan koin, dapatkan combo!</p>

            <div class="stats-container">
                <div class="stat-card"><div class="stat-icon">üèÜ</div><div class="stat-value" id="best-score">0</div><div class="stat-label">Best</div></div>
                <div class="stat-card"><div class="stat-icon">üéÆ</div><div class="stat-value" id="total-plays">0</div><div class="stat-label">Plays</div></div>
                <div class="stat-card"><div class="stat-icon">ü™ô</div><div class="stat-value" id="total-coins">0</div><div class="stat-label">Coins</div></div>
            </div>

            <button class="btn-primary" id="start-btn">MAIN SEKARANG</button>
        </div>

        <div id="game-over-screen" class="screen hidden">
            <div class="game-over-content">
                <div class="crash-icon">üí•</div>
                <div class="new-record" id="new-record">NEW RECORD! üéâ</div>
                
                <div class="final-score-box">
                    <div class="final-score-label">SKOR AKHIR</div>
                    <div class="final-score-value" id="final-score">0</div>
                </div>

                <div class="details-grid">
                    <div class="detail-item"><div class="detail-label">üèÖ Medali</div><div class="detail-value" id="final-medal">-</div></div>
                    <div class="detail-item"><div class="detail-label">üî• Max Combo</div><div class="detail-value" id="final-combo">0</div></div>
                    <div class="detail-item"><div class="detail-label">ü™ô Koin</div><div class="detail-value" id="final-coins">0</div></div>
                    <div class="detail-item"><div class="detail-label">‚ú® Perfect</div><div class="detail-value" id="final-perfect">0</div></div>
                </div>

                <button class="btn-primary" id="restart-btn">COBA LAGI</button>
                <button class="btn-secondary" id="menu-btn">MENU</button>
            </div>
        </div>
    </div>

    <script>
        // ==================== AUDIO SYSTEM ====================
        const AudioContext = window.AudioContext || window.webkitAudioContext;
        let audioCtx;
        function initAudio() { if (!audioCtx) audioCtx = new AudioContext(); if (audioCtx.state === 'suspended') audioCtx.resume(); }

        const sfx = {
            jump: () => {
                if (!audioCtx) return;
                const osc = audioCtx.createOscillator(); const gain = audioCtx.createGain();
                osc.frequency.setValueAtTime(400, audioCtx.currentTime); osc.frequency.exponentialRampToValueAtTime(600, audioCtx.currentTime + 0.1);
                gain.gain.setValueAtTime(0.2, audioCtx.currentTime); gain.gain.exponentialRampToValueAtTime(0.01, audioCtx.currentTime + 0.1);
                osc.connect(gain); gain.connect(audioCtx.destination); osc.start(); osc.stop(audioCtx.currentTime + 0.1);
            },
            score: () => {
                if (!audioCtx) return;
                const osc = audioCtx.createOscillator(); const gain = audioCtx.createGain();
                osc.type = 'sine'; osc.frequency.setValueAtTime(800, audioCtx.currentTime);
                gain.gain.setValueAtTime(0.15, audioCtx.currentTime); gain.gain.exponentialRampToValueAtTime(0.01, audioCtx.currentTime + 0.15);
                osc.connect(gain); gain.connect(audioCtx.destination); osc.start(); osc.stop(audioCtx.currentTime + 0.15);
            },
            coin: () => {
                if (!audioCtx) return;
                const osc = audioCtx.createOscillator(); const gain = audioCtx.createGain();
                osc.type = 'square'; osc.frequency.setValueAtTime(1200, audioCtx.currentTime);
                gain.gain.setValueAtTime(0.1, audioCtx.currentTime); gain.gain.exponentialRampToValueAtTime(0.01, audioCtx.currentTime + 0.1);
                osc.connect(gain); gain.connect(audioCtx.destination); osc.start(); osc.stop(audioCtx.currentTime + 0.1);
            },
            powerup: () => {
                if (!audioCtx) return;
                // Suara khusus untuk powerup
                const osc = audioCtx.createOscillator(); const gain = audioCtx.createGain();
                osc.type = 'sine'; 
                osc.frequency.setValueAtTime(600, audioCtx.currentTime);
                osc.frequency.exponentialRampToValueAtTime(1200, audioCtx.currentTime + 0.2);
                gain.gain.setValueAtTime(0.2, audioCtx.currentTime); 
                gain.gain.exponentialRampToValueAtTime(0.01, audioCtx.currentTime + 0.3);
                osc.connect(gain); gain.connect(audioCtx.destination); 
                osc.start(); 
                osc.stop(audioCtx.currentTime + 0.3);
            },
            shieldBreak: () => {
                if (!audioCtx) return;
                // Suara saat shield pecah
                const osc = audioCtx.createOscillator(); const gain = audioCtx.createGain();
                osc.type = 'sawtooth'; 
                osc.frequency.setValueAtTime(300, audioCtx.currentTime);
                osc.frequency.exponentialRampToValueAtTime(100, audioCtx.currentTime + 0.3);
                gain.gain.setValueAtTime(0.3, audioCtx.currentTime); 
                gain.gain.exponentialRampToValueAtTime(0.01, audioCtx.currentTime + 0.3);
                osc.connect(gain); gain.connect(audioCtx.destination); 
                osc.start(); 
                osc.stop(audioCtx.currentTime + 0.3);
            },
            crash: () => {
                if (!audioCtx) return;
                const osc = audioCtx.createOscillator(); const gain = audioCtx.createGain();
                osc.type = 'sawtooth'; osc.frequency.setValueAtTime(200, audioCtx.currentTime); osc.frequency.exponentialRampToValueAtTime(50, audioCtx.currentTime + 0.3);
                gain.gain.setValueAtTime(0.3, audioCtx.currentTime); gain.gain.exponentialRampToValueAtTime(0.01, audioCtx.currentTime + 0.3);
                osc.connect(gain); gain.connect(audioCtx.destination); osc.start(); osc.stop(audioCtx.currentTime + 0.3);
            }
        };

        // ==================== GAME SETUP ====================
        const canvas = document.getElementById('game');
        const ctx = canvas.getContext('2d');
        function resizeCanvas() { canvas.width = document.getElementById('game-wrapper').clientWidth; canvas.height = document.getElementById('game-wrapper').clientHeight; }
        resizeCanvas(); window.addEventListener('resize', resizeCanvas);

        let gameState = 'START'; // START, READY, PLAYING, GAMEOVER
        let frames = 0; let deathFrame = 0; let score = 0; let coins = 0; let combo = 0; let maxCombo = 0; let perfectPasses = 0; 
        let gameSpeed = 2;
        let difficulty = 1; let groundOffset = 0;
        
        const POWERUP_DURATION = 400; // Durasi powerup dalam frame (~6.5 detik)
        
        const stats = { bestScore: parseInt(localStorage.getItem('skyBestScore')) || 0, totalPlays: parseInt(localStorage.getItem('skyTotalPlays')) || 0, totalCoins: parseInt(localStorage.getItem('skyTotalCoins')) || 0 };
        document.getElementById('best-score').textContent = stats.bestScore; document.getElementById('total-plays').textContent = stats.totalPlays; document.getElementById('total-coins').textContent = stats.totalCoins;

        let particles = [];
        class Particle {
            constructor(x, y, type, color) {
                this.x = x; this.y = y; this.type = type; this.color = color; this.life = 1;
                this.vx = (Math.random() - 0.5) * 6; this.vy = (Math.random() - 0.5) * 6; this.size = Math.random() * 4 + 2;
                if (type === 'feather') { this.vy = Math.random() * -3 - 1; this.vx = (Math.random() - 0.5) * 2; this.decay = 0.02; this.gravity = 0.1; } 
                else if (type === 'sparkle') { this.decay = 0.03; this.gravity = 0; } 
                else if (type === 'crash') { this.vx *= 2; this.vy *= 2; this.decay = 0.015; this.gravity = 0.2; }
                else if (type === 'shieldBreak') { this.vx *= 3; this.vy *= 3; this.decay = 0.02; this.gravity = 0.1; this.size = Math.random() * 6 + 4; }
            }
            update() {
                this.x += this.vx; this.y += this.vy; this.life -= this.decay;
                if (this.type === 'feather' || this.type === 'crash' || this.type === 'shieldBreak') this.vy += this.gravity;
                if (this.type === 'feather') this.vx *= 0.99;
            }
            draw(ctx) {
                ctx.save(); ctx.globalAlpha = this.life; ctx.fillStyle = this.color;
                if (this.type === 'feather') { ctx.beginPath(); ctx.ellipse(this.x, this.y, this.size, this.size/2, this.life * Math.PI, 0, Math.PI * 2); ctx.fill(); } 
                else if (this.type === 'shieldBreak') {
                    // Partikel pecahan shield
                    ctx.fillStyle = '#4299e1';
                    ctx.beginPath(); ctx.arc(this.x, this.y, this.size, 0, Math.PI * 2); ctx.fill();
                }
                else { ctx.beginPath(); ctx.arc(this.x, this.y, this.size, 0, Math.PI * 2); ctx.fill(); }
                ctx.restore();
            }
        }
        function spawnParticles(x, y, count, type, color) { for (let i = 0; i < count; i++) particles.push(new Particle(x, y, type, color)); }

        // ==================== BIRD ====================
        const bird = {
            x: 80, y: 0, velocity: 0, radius: 16, gravity: 0.25, jumpPower: -5.5, rotation: 0, trail: [], 
            powerups: { shield: false, magnet: false, slowmo: false }, 
            powerupTimers: { shield: 0, magnet: 0, slowmo: 0 }, 
            invulnerable: 0,
            maxTimers: { shield: 0, magnet: 0, slowmo: 0 }, // Untuk tracking durasi maksimum
            
            reset() {
                this.y = canvas.height / 2; this.velocity = 0; this.rotation = 0; this.trail = []; 
                this.powerups = {shield: false, magnet: false, slowmo: false}; 
                this.powerupTimers = {shield: 0, magnet: 0, slowmo: 0};
                this.maxTimers = {shield: 0, magnet: 0, slowmo: 0};
                this.invulnerable = 0;
                this.updatePowerupUI();
            },
            
            update() {
                this.velocity += this.gravity; this.y += this.velocity;
                this.rotation = Math.min(Math.PI / 4, Math.max(-Math.PI / 4, this.velocity * 0.08));
                
                if (frames % 4 === 0 && gameState === 'PLAYING') this.trail.push({x: this.x, y: this.y, life: 1});
                this.trail.forEach(t => t.life -= 0.1); this.trail = this.trail.filter(t => t.life > 0);
                
                // Update powerup timers
                Object.keys(this.powerupTimers).forEach(key => {
                    if (this.powerupTimers[key] > 0) {
                        this.powerupTimers[key]--;
                        if (this.powerupTimers[key] <= 0) { 
                            this.deactivatePowerup(key);
                        }
                    }
                });
                
                if (this.invulnerable > 0) this.invulnerable--;
                
                // Mencegah burung tembus tanah
                const floorY = canvas.height - 80;
                if (this.y + this.radius >= floorY) {
                    this.y = floorY - this.radius;
                    if (gameState === 'PLAYING') gameOver();
                }
                if (this.y - this.radius < 0) { this.y = this.radius; this.velocity = 0; }
                
                this.updatePowerupUI();
            },
            
            activatePowerup(type) {
                this.powerups[type] = true;
                this.powerupTimers[type] = POWERUP_DURATION;
                this.maxTimers[type] = POWERUP_DURATION;
                document.getElementById(`badge-${type}`).classList.add('active');
                sfx.powerup();
                spawnParticles(this.x, this.y, 15, 'sparkle', '#ffffff');
            },
            
            deactivatePowerup(type) {
                this.powerups[type] = false;
                this.powerupTimers[type] = 0;
                this.maxTimers[type] = 0;
                document.getElementById(`badge-${type}`).classList.remove('active');
                document.getElementById(`timer-${type}`).style.width = '100%';
            },
            
            // FIX: Method khusus untuk memecahkan shield saat nabrak
            breakShield() {
                if (!this.powerups.shield) return;
                
                // Efek visual pecahan shield
                spawnParticles(this.x, this.y, 20, 'shieldBreak', '#4299e1');
                sfx.shieldBreak();
                
                // Deaktivasi shield
                this.deactivatePowerup('shield');
                this.invulnerable = 60; // Kebal lebih lama setelah shield pecah (1 detik)
                
                // Efek getaran layar (visual feedback)
                canvas.style.transform = 'translateX(5px)';
                setTimeout(() => canvas.style.transform = 'translateX(-5px)', 50);
                setTimeout(() => canvas.style.transform = 'translateX(5px)', 100);
                setTimeout(() => canvas.style.transform = 'translateX(0)', 150);
            },
            
            updatePowerupUI() {
                // Update progress bar untuk setiap powerup
                ['shield', 'magnet', 'slowmo'].forEach(type => {
                    const timerBar = document.getElementById(`timer-${type}`);
                    if (this.powerups[type] && this.maxTimers[type] > 0) {
                        const percentage = (this.powerupTimers[type] / this.maxTimers[type]) * 100;
                        timerBar.style.width = percentage + '%';
                    } else {
                        timerBar.style.width = '100%';
                    }
                });
            },
            
            jump() {
                this.velocity = this.jumpPower; sfx.jump();
                spawnParticles(this.x - 10, this.y + 10, 3, 'feather', '#ffffff');
            },
            
            draw(ctx) {
                this.trail.forEach((t, i) => {
                    ctx.save(); ctx.globalAlpha = t.life * 0.3; ctx.fillStyle = '#ffd93d'; ctx.beginPath();
                    ctx.arc(t.x - (this.trail.length - i) * 3, t.y, this.radius * 0.5 * t.life, 0, Math.PI * 2); ctx.fill(); ctx.restore();
                });
                
                ctx.save(); ctx.translate(this.x, this.y); ctx.rotate(this.rotation);
                
                // ==================== VISUALISASI SHIELD DENGAN TIMER ====================
                if (this.powerups.shield) {
                    const remaining = this.powerupTimers.shield;
                    const max = this.maxTimers.shield || POWERUP_DURATION;
                    const progress = remaining / max;
                    
                    // Lingkaran luar (background)
                    ctx.beginPath();
                    ctx.strokeStyle = 'rgba(66, 153, 225, 0.3)';
                    ctx.lineWidth = 4;
                    ctx.arc(0, 0, this.radius + 15, 0, Math.PI * 2);
                    ctx.stroke();
                    
                    // Lingkaran timer (yang berkurang)
                    ctx.beginPath();
                    ctx.strokeStyle = '#4299e1';
                    ctx.lineWidth = 4;
                    ctx.lineCap = 'round';
                    // Mulai dari -90 derajat (atas)
                    const startAngle = -Math.PI / 2;
                    const endAngle = startAngle + (Math.PI * 2 * progress);
                    ctx.arc(0, 0, this.radius + 15, startAngle, endAngle);
                    ctx.stroke();
                    
                    // Efek glow pulsasi
                    ctx.save();
                    ctx.globalAlpha = 0.6 + Math.sin(frames * 0.2) * 0.2;
                    ctx.strokeStyle = '#63b3ed';
                    ctx.lineWidth = 2;
                    ctx.beginPath();
                    ctx.arc(0, 0, this.radius + 18, 0, Math.PI * 2);
                    ctx.stroke();
                    ctx.restore();
                    
                    // Teks timer detik
                    if (remaining < 180) { // Tampilkan teks saat < 3 detik
                        ctx.save();
                        ctx.fillStyle = '#4299e1';
                        ctx.font = 'bold 12px Nunito';
                        ctx.textAlign = 'center';
                        ctx.textBaseline = 'middle';
                        ctx.fillText(Math.ceil(remaining / 60), 0, -this.radius - 25);
                        ctx.restore();
                    }
                }
                
                // Efek magnet (lingkaran tarikan)
                if (this.powerups.magnet) {
                    ctx.save();
                    ctx.globalAlpha = 0.3;
                    ctx.strokeStyle = '#ecc94b';
                    ctx.lineWidth = 2;
                    ctx.beginPath();
                    ctx.arc(0, 0, 150, 0, Math.PI * 2);
                    ctx.stroke();
                    ctx.restore();
                }
                
                const bodyGrad = ctx.createRadialGradient(-5, -5, 0, 0, 0, this.radius);
                bodyGrad.addColorStop(0, '#ffe066'); bodyGrad.addColorStop(0.7, '#ffd43b'); bodyGrad.addColorStop(1, '#fcc419');
                ctx.fillStyle = bodyGrad; ctx.beginPath(); ctx.arc(0, 0, this.radius, 0, Math.PI * 2); ctx.fill();
                
                ctx.fillStyle = 'white'; ctx.beginPath(); ctx.arc(6, -4, 7, 0, Math.PI * 2); ctx.fill();
                ctx.fillStyle = '#2d3748'; ctx.beginPath(); ctx.arc(8, -4, 3.5, 0, Math.PI * 2); ctx.fill();
                
                ctx.fillStyle = '#ff6b6b'; ctx.beginPath(); ctx.moveTo(10, 0); ctx.lineTo(20, 3); ctx.lineTo(10, 6); ctx.closePath(); ctx.fill();
                
                const flap = Math.sin(frames * 0.3) * 0.3;
                ctx.save(); ctx.translate(-5, 5); ctx.rotate(flap); ctx.fillStyle = '#fff9db'; ctx.beginPath(); ctx.ellipse(0, 0, 10, 6, 0, 0, Math.PI * 2); ctx.fill(); ctx.restore();
                
                ctx.fillStyle = '#fcc419'; ctx.beginPath(); ctx.moveTo(-12, 0); ctx.lineTo(-20, -5); ctx.lineTo(-20, 5); ctx.closePath(); ctx.fill();
                ctx.restore();
            }
        };

        // ==================== PIPES & ITEMS ====================
        let pipes = []; let items = [];
        class Pipe {
            constructor() {
                this.x = canvas.width; this.w = 65;
                this.gap = Math.max(150 - (difficulty * 5), 120);
                this.minHeight = 60; const maxPos = canvas.height - 80 - this.gap - this.minHeight * 2;
                this.topHeight = Math.floor(Math.random() * maxPos) + this.minHeight; 
                this.bottomY = this.topHeight + this.gap;
                this.passed = false; this.scored = false;
            }
            update(speed) { this.x -= speed; }
            draw(ctx) {
                const grad = ctx.createLinearGradient(this.x, 0, this.x + this.w, 0);
                grad.addColorStop(0, '#74c02c');
                grad.addColorStop(0.5, '#95e43c');
                grad.addColorStop(1, '#54901c');

                ctx.fillStyle = grad;
                ctx.lineWidth = 3;
                ctx.strokeStyle = '#24520c';

                const capHeight = 25;
                const capExtraWidth = 10;

                ctx.fillRect(this.x, 0, this.w, this.topHeight - capHeight);
                ctx.strokeRect(this.x, 0, this.w, this.topHeight - capHeight);
                ctx.fillRect(this.x - (capExtraWidth/2), this.topHeight - capHeight, this.w + capExtraWidth, capHeight);
                ctx.strokeRect(this.x - (capExtraWidth/2), this.topHeight - capHeight, this.w + capExtraWidth, capHeight);

                const bottomBodyHeight = canvas.height - this.bottomY - 80;
                ctx.fillRect(this.x - (capExtraWidth/2), this.bottomY, this.w + capExtraWidth, capHeight);
                ctx.strokeRect(this.x - (capExtraWidth/2), this.bottomY, this.w + capExtraWidth, capHeight);
                ctx.fillRect(this.x, this.bottomY + capHeight, this.w, bottomBodyHeight - capHeight);
                ctx.strokeRect(this.x, this.bottomY + capHeight, this.w, bottomBodyHeight - capHeight);
            }
        }

        class Cloud {
            constructor(x) {
                this.x = x !== undefined ? x : canvas.width + Math.random() * 100;
                this.y = Math.random() * (canvas.height / 2.5);
                this.speed = Math.random() * 0.5 + 0.2;
                this.scale = Math.random() * 0.6 + 0.4;
            }
            update(baseSpeed) {
                this.x -= this.speed * (bird.powerups.slowmo ? 0.5 : 1);
            }
            draw(ctx) {
                ctx.save();
                ctx.fillStyle = 'rgba(255, 255, 255, 0.6)';
                ctx.beginPath();
                ctx.arc(this.x, this.y, 20 * this.scale, Math.PI * 0.5, Math.PI * 1.5);
                ctx.arc(this.x + 15 * this.scale, this.y - 15 * this.scale, 20 * this.scale, Math.PI * 1, Math.PI * 2);
                ctx.arc(this.x + 35 * this.scale, this.y, 25 * this.scale, Math.PI * 1.5, Math.PI * 0.5);
                ctx.moveTo(this.x, this.y + 20 * this.scale);
                ctx.lineTo(this.x + 35 * this.scale, this.y + 25 * this.scale);
                ctx.fill();
                ctx.restore();
            }
        }

        let clouds = [new Cloud(100), new Cloud(250), new Cloud(400)];

        class Item {
            constructor(x, y, type) {
                this.x = x; this.y = y; this.type = type;
                this.radius = 12; this.baseY = y; this.frame = Math.random() * 100;
                this.collected = false;
            }
            update(speed) {
                this.x -= speed;
                this.frame += 0.1;
                this.y = this.baseY + Math.sin(this.frame) * 5;

                if (this.type === 'coin' && bird.powerups.magnet) {
                    const dx = bird.x - this.x; const dy = bird.y - this.y;
                    const dist = Math.sqrt(dx * dx + dy * dy);
                    if (dist < 150) {
                        this.x += dx * 0.15; this.y += dy * 0.15;
                    }
                }
            }
            draw(ctx) {
                ctx.save(); ctx.translate(this.x, this.y);
                if (this.type === 'coin') {
                    // Animasi koin berputar
                    const scale = Math.abs(Math.sin(this.frame * 0.5));
                    ctx.scale(scale, 1);
                    
                    ctx.fillStyle = '#ffd93d'; ctx.beginPath(); ctx.arc(0, 0, this.radius, 0, Math.PI * 2); ctx.fill();
                    ctx.fillStyle = '#f6ad55'; ctx.beginPath(); ctx.arc(0, 0, this.radius - 3, 0, Math.PI * 2); ctx.fill();
                    ctx.fillStyle = '#fff'; ctx.font = 'bold 12px Nunito'; ctx.textAlign = 'center'; ctx.textBaseline = 'middle'; ctx.fillText('$', 0, 1);
                } else {
                    const colors = { shield: '#4299e1', magnet: '#ecc94b', slowmo: '#9f7aea' };
                    const icons = { shield: 'üõ°Ô∏è', magnet: 'üß≤', slowmo: '‚è±Ô∏è' };
                    ctx.fillStyle = colors[this.type];
                    ctx.beginPath(); ctx.arc(0, 0, this.radius + 2, 0, Math.PI * 2); ctx.fill();
                    
                    // Efek pulse untuk powerup
                    ctx.save();
                    ctx.globalAlpha = 0.5 + Math.sin(this.frame * 0.5) * 0.3;
                    ctx.strokeStyle = colors[this.type];
                    ctx.lineWidth = 2;
                    ctx.beginPath(); ctx.arc(0, 0, this.radius + 6 + Math.sin(this.frame * 0.5) * 2, 0, Math.PI * 2); ctx.stroke();
                    ctx.restore();
                    
                    ctx.fillStyle = '#fff'; ctx.font = '12px Arial'; ctx.textAlign = 'center'; ctx.textBaseline = 'middle'; ctx.fillText(icons[this.type], 0, 1);
                }
                ctx.restore();
            }
        }

        // ==================== BACKGROUND ====================
        function drawBackground() {
            const skyGrad = ctx.createLinearGradient(0, 0, 0, canvas.height);
            skyGrad.addColorStop(0, '#63b3ed'); skyGrad.addColorStop(0.5, '#90cdf4'); skyGrad.addColorStop(1, '#bee3f8');
            ctx.fillStyle = skyGrad; ctx.fillRect(0, 0, canvas.width, canvas.height);
            
            clouds.forEach(cloud => cloud.draw(ctx));

            const floorY = canvas.height - 80;
            ctx.fillStyle = '#48bb78'; ctx.fillRect(0, floorY, canvas.width, 80);
            
            ctx.fillStyle = '#38a169';
            for (let x = 0; x < canvas.width + 50; x += 30) {
                const drawX = x - (groundOffset % 30);
                const h = 10 + Math.sin(x * 0.1) * 5;
                ctx.fillRect(drawX, floorY, 15, h);
            }
            ctx.fillStyle = '#2f855a'; ctx.fillRect(0, floorY, canvas.width, 8);
        }

        // ==================== GAME LOGIC ====================
        let spawnTimer = 0; let comboTimer = 0;
        let lastScoreTime = 0;
        let consecutiveCoins = 0;

        function resetGame() {
            bird.reset(); pipes = []; items = []; particles = []; clouds = [new Cloud(100), new Cloud(300)];
            score = 0; coins = 0; combo = 0; maxCombo = 0; perfectPasses = 0; gameSpeed = 2; difficulty = 1; spawnTimer = 0; comboTimer = 0; frames = 0; consecutiveCoins = 0;
            
            document.getElementById('score-display').textContent = '0'; document.getElementById('medal').textContent = 'ü•â';
            document.getElementById('combo-banner').classList.remove('combo-show');
            
            // Reset UI powerup
            ['shield', 'magnet', 'slowmo'].forEach(type => {
                document.getElementById(`badge-${type}`).classList.remove('active');
                document.getElementById(`timer-${type}`).style.width = '100%';
            });
            
            gameState = 'READY';
            document.getElementById('start-screen').classList.add('hidden');
            document.getElementById('game-over-screen').classList.add('hidden');
        }

        function showFloatingText(text, x, y, color) {
            const el = document.createElement('div');
            el.className = 'floating-text';
            el.textContent = text;
            el.style.left = x + 'px';
            el.style.top = y + 'px';
            el.style.color = color;
            document.getElementById('game-wrapper').appendChild(el);
            setTimeout(() => el.remove(), 1000);
        }

        function gameOver() {
            if (gameState === 'GAMEOVER') return;
            gameState = 'GAMEOVER'; deathFrame = frames;
            sfx.crash(); spawnParticles(bird.x, bird.y, 20, 'crash', '#ff6b6b');
            
            stats.totalPlays++;
            if (score > stats.bestScore) { 
                stats.bestScore = score; 
                document.getElementById('new-record').classList.add('show'); 
            } else { 
                document.getElementById('new-record').classList.remove('show'); 
            }
            stats.totalCoins += coins;
            
            localStorage.setItem('skyBestScore', stats.bestScore); 
            localStorage.setItem('skyTotalPlays', stats.totalPlays); 
            localStorage.setItem('skyTotalCoins', stats.totalCoins);
            
            let medal = score >= 200 ? 'üíé' : score >= 100 ? 'ü•á' : score >= 50 ? 'ü•à' : 'ü•â';
            setTimeout(() => {
                document.getElementById('final-score').textContent = score; 
                document.getElementById('final-medal').textContent = medal;
                document.getElementById('final-combo').textContent = maxCombo; 
                document.getElementById('final-coins').textContent = coins;
                document.getElementById('final-perfect').textContent = perfectPasses;
                document.getElementById('game-over-screen').classList.remove('hidden');
            }, 500);
        }

        function update() {
            frames++;
            
            if (gameState === 'READY') {
                bird.y = canvas.height / 2 + Math.sin(frames * 0.1) * 10;
                bird.rotation = 0;
                groundOffset += gameSpeed;
            } 
            else if (gameState === 'PLAYING') {
                bird.update();
                
                let currentSpeed = bird.powerups.slowmo ? gameSpeed * 0.5 : gameSpeed;
                groundOffset += currentSpeed;
                
                clouds.forEach(cloud => cloud.update());
                if (frames % 150 === 0) clouds.push(new Cloud());
                clouds = clouds.filter(c => c.x > -50);

                spawnTimer++;
                if (spawnTimer > Math.max(50, 100 - difficulty * 5)) {
                    spawnTimer = 0; 
                    let newPipe = new Pipe();
                    pipes.push(newPipe);

                    if (Math.random() < 0.8) {
                        let itemType = 'coin';
                        let rand = Math.random();
                        
                        // Peluang power-up
                        if (rand < 0.08) itemType = 'shield';      
                        else if (rand < 0.16) itemType = 'magnet'; 
                        else if (rand < 0.24) itemType = 'slowmo'; 
                        
                        items.push(new Item(newPipe.x + newPipe.w / 2, newPipe.topHeight + newPipe.gap / 2, itemType));
                    }
                }
                
                // UPDATE ITEM & DETEKSI TABRAKAN
                for (let i = items.length - 1; i >= 0; i--) {
                    let item = items[i];
                    item.update(currentSpeed);
                    
                    const dx = bird.x - item.x; const dy = bird.y - item.y;
                    const dist = Math.sqrt(dx * dx + dy * dy);
                    
                    if (dist < bird.radius + item.radius) {
                        if (item.type === 'coin') {
                            coins++;
                            consecutiveCoins++;
                            
                            // Combo system: semakin banyak koin berturut-turut, semakin besar bonus
                            if (consecutiveCoins > 1) {
                                const bonus = Math.min(consecutiveCoins * 10, 50);
                                showFloatingText(`+${bonus}`, bird.x, bird.y - 30, '#ffd93d');
                            }
                            
                            document.getElementById('total-coins').textContent = stats.totalCoins + coins;
                            sfx.coin();
                            spawnParticles(item.x, item.y, 5, 'sparkle', '#ffd93d');
                        } else {
                            bird.activatePowerup(item.type);
                        }
                        items.splice(i, 1);
                        continue;
                    }
                    if (item.x < -50) {
                        if (item.type === 'coin') consecutiveCoins = 0; // Reset combo jika koin dilewatkan
                        items.splice(i, 1);
                    }
                }
                
                // UPDATE PIPA & KESULITAN PROGRESIF
                for (let i = pipes.length - 1; i >= 0; i--) {
                    const pipe = pipes[i]; 
                    pipe.update(currentSpeed);
                    
                    // Deteksi tabrakan
                    const hitPadding = 6; 
                    const birdLeft = bird.x - bird.radius + hitPadding;
                    const birdRight = bird.x + bird.radius - hitPadding;
                    const birdTop = bird.y - bird.radius + hitPadding;
                    const birdBottom = bird.y + bird.radius - hitPadding;

                    const hitX = birdRight > pipe.x && birdLeft < pipe.x + pipe.w;
                    const hitY = birdTop < pipe.topHeight || birdBottom > pipe.bottomY;
                    
                    if (hitX && hitY) {
                        // FIX: Gunakan method breakShield() yang benar
                        if (bird.powerups.shield) {
                            bird.breakShield();
                            spawnParticles(pipe.x, bird.y, 15, 'crash', '#48bb78');
                            pipes.splice(i, 1);
                            continue;
                        } else if (bird.invulnerable <= 0) {
                            gameOver();
                            return;
                        }
                    }
                    
                    // Scoring
                    if (!pipe.scored && bird.x > pipe.x + pipe.w) {
                        pipe.scored = true; 
                        score++;
                        
                        // Perfect pass detection (lewat tengah)
                        const centerGap = pipe.topHeight + (pipe.gap / 2);
                        const distFromCenter = Math.abs(bird.y - centerGap);
                        if (distFromCenter < 30) {
                            perfectPasses++;
                            showFloatingText('PERFECT!', bird.x, bird.y - 50, '#48bb78');
                            spawnParticles(bird.x, bird.y, 10, 'sparkle', '#48bb78');
                        }
                        
                        document.getElementById('score-display').textContent = score; 
                        sfx.score();
                        
                        // Level up setiap kelipatan 10
                        if (score > 0 && score % 10 === 0) {
                            if (gameSpeed < 7) gameSpeed += 0.5;
                            difficulty += 0.5;
                            
                            let banner = document.getElementById('combo-banner');
                            banner.textContent = `LEVEL ${Math.floor(score/10)}! üî•`;
                            banner.classList.add('combo-show');
                            setTimeout(() => banner.classList.remove('combo-show'), 1500);
                            
                            showFloatingText('SPEED UP!', canvas.width/2, 150, '#ff6b6b');
                        }
                    }
                    if (pipe.x + pipe.w < -50) pipes.splice(i, 1);
                }
            } 
            else if (gameState === 'GAMEOVER') {
                if (bird.y + bird.radius < canvas.height - 80) bird.update();
            }
            
            particles.forEach(p => p.update()); 
            particles = particles.filter(p => p.life > 0);
        }

        function draw() {
            ctx.clearRect(0, 0, canvas.width, canvas.height);
            drawBackground();
            pipes.forEach(pipe => pipe.draw(ctx));
            items.forEach(item => item.draw(ctx));
            
            if (gameState !== 'START') bird.draw(ctx);
            particles.forEach(p => p.draw(ctx));

            if (gameState === 'READY') {
                ctx.save();
                ctx.fillStyle = 'rgba(255, 255, 255, 0.9)'; 
                ctx.font = '900 24px Nunito, sans-serif'; 
                ctx.textAlign = 'center';
                ctx.shadowColor = 'rgba(0,0,0,0.4)'; 
                ctx.shadowBlur = 10;
                ctx.fillText('TAP UNTUK TERBANG', canvas.width / 2, canvas.height / 2 + 80);
                ctx.font = '900 20px Nunito, sans-serif'; 
                ctx.fillText('üëÜ', canvas.width / 2, canvas.height / 2 + 115);
                ctx.restore();
            }
            
            // Draw combo counter
            if (consecutiveCoins > 1 && gameState === 'PLAYING') {
                ctx.save();
                ctx.fillStyle = '#ffd93d';
                ctx.font = '900 20px Nunito';
                ctx.textAlign = 'center';
                ctx.fillText(`STREAK x${consecutiveCoins}`, bird.x, bird.y - 40);
                ctx.restore();
            }
        }

        function loop() { update(); draw(); requestAnimationFrame(loop); }

        // ==================== INPUT ====================
        function handleInput(e) {
            if (e.type === 'keydown' && e.code !== 'Space') return;
            if (e.type === 'touchstart') e.preventDefault();
            initAudio();
            
            if (gameState === 'READY') {
                gameState = 'PLAYING';
                bird.jump();
            } else if (gameState === 'PLAYING') {
                bird.jump();
            } else if (gameState === 'GAMEOVER') {
                if (frames - deathFrame > 40) resetGame();
            }
        }

        window.addEventListener('keydown', handleInput);
        canvas.addEventListener('mousedown', handleInput);
        canvas.addEventListener('touchstart', handleInput, {passive: false});
        
        document.getElementById('start-btn').addEventListener('click', (e) => {
            e.stopPropagation();
            initAudio(); 
            resetGame();
        });
        
        document.getElementById('restart-btn').addEventListener('click', resetGame);
        document.getElementById('menu-btn').addEventListener('click', () => {
            document.getElementById('game-over-screen').classList.add('hidden'); 
            document.getElementById('start-screen').classList.remove('hidden'); 
            gameState = 'START';
        });

        loop();
    </script>
</body>
</html>